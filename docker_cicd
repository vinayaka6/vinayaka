sudo groupadd docker
sudo usermod -a -G docker jenkins

pipeline {

    agent any

 

    tools

        {

        maven "maven project"

        }

    stages {

        stage('checkout') {

                steps {

                    

                    git branch: 'master', url: 'https://github.com/devops4solutions/CI-CD-using-Docker.git'            

                }

        }

        stage('Execute Maven') {

                steps {

                    

                    sh 'mvn package'             

                }

        }

        stage('Docker Build and Tag') {

                steps {

                    

                    sh 'docker build -t webapplication:latest .'

                    //sh 'docker tag webapplication:latest vinayaka8/dockercicd'

                    sh 'docker tag webapplication:latest vinayaka8/dockercicd:$BUILD_NUMBER'

                }

        }

        stage('Publish image to Docker Hub') {

                steps {

                        withDockerRegistry([ credentialsId: "dockerhub", url: "https://index.docker.io/v1/" ]) {

                        //sh  'docker push vinayaka8/dockercicd'

                          sh  'docker push vinayaka8/dockercicd:$BUILD_NUMBER'

                        }        

                }

        }

        stage('Run Docker container on Jenkins Agent') {

                    

                steps {

                        sh "docker run -d -p 8004:8080 vinayaka8/dockercicd:$BUILD_NUMBER"

                }

        }

        //stage('Run Docker container on remote hosts') {

                    

                    //steps {

                        //sh "docker -H ssh://jenkins@ip run -d -p 8003:8080 vinayaka8/dockercicd"

                    //}

        //}

    }

}
